export const metadata = {
  title: 'Import',
  description:
    "On this page, we'll dive into how to import games and versions on Drop, and the options for both.",
}

# Import

While games and versions should be covered in separate sections, importing is a complicated enough of a process to warrant a separate page. Importing is the process of pulling and providing metadata for various complex objects in Drop, namely games and versions.

Both games and versions in Drop are required to imported manually, due to them having additional metadata that must be user-provided.

---

## Game metadata

Game metadata is provided by a series of backend 'metadata providers'. Drop unifies them all into a single API to import the metadata, and handle authentication seamlessly.

---

## Fetch unimported games {{ tag: 'GET', label: '/api/v1/admin/import/game', apilevel: "system", acl: "import:game:read" }}

<Row>
  <Col>

    This endpoint fetches all unimported games on the instance.

  </Col>
  <Col sticky>

    <CodeGroup title="Request" tag="GET" label="/api/v1/admin/import/game">

    ```bash {{ title: 'cURL' }}
    curl -G http://localhost:3000/api/v1/admin/import/game \
      -H "Authorization: Bearer {token}"
    ```

    ```js
    const response = await fetch("http://localhost:3000/api/v1/admin/import/game", {
        headers: {
            Authorization: "Bearer {token}"
        },
    });

    const results = await response.json();

    ```

    </CodeGroup>

    ```json {{ title: 'Response' }}
    {
        "unimportedGames": [
            {
                "game": "Abiotic Factor",
                "library": {
                    "id": "8dc4b769-090f-4aec-b73a-d8fafc84f418",
                    "name": "Example Library",
                    "backend": "Filesystem",
                    "options": {
                        "baseDir": "./.data/library"
                    },
                    "working": true
                }
            },
            {
                "game": "Balatro",
                "library": {
                    "id": "8dc4b769-090f-4aec-b73a-d8fafc84f418",
                    "name": "Example Library",
                    "backend": "Filesystem",
                    "options": {
                        "baseDir": "./.data/library"
                    },
                    "working": true
                }
            },
            {
                "game": "SuperTuxKart",
                "library": {
                    "id": "8dc4b769-090f-4aec-b73a-d8fafc84f418",
                    "name": "Example Library",
                    "backend": "Filesystem",
                    "options": {
                        "baseDir": "./.data/library"
                    },
                    "working": true
                }
            }
        ]
    }
    ```

  </Col>
</Row>

---

## Search metadata {{ tag: 'GET', label: '/api/v1/admin/import/game/search', apilevel: "system", acl: "import:game:read" }}

<Row>
  <Col>

    This endpoint searches all metadata providers for a query.


    ### Query parameters

    <Properties>
      <Property name="q" type="string">
        URL-encoded query you want to search.
      </Property>
    </Properties>

  </Col>
  <Col sticky>

    <CodeGroup title="Request" tag="GET" label="/api/v1/admin/import/game/search">

    ```bash {{ title: 'cURL' }}
    curl -G http://localhost:3000/api/v1/admin/import/game/search?q={query} \
      -H "Authorization: Bearer {token}"
    ```

    ```js
    const response = await fetch("http://localhost:3000/api/v1/admin/import/game?q={query}", {
        headers: {
            Authorization: "Bearer {token}"
        },
    });

    const results = await response.json();

    ```

    </CodeGroup>

    ```json {{ title: 'Response' }}
    [
        {
            "id": "182101",
            "name": "Bird by Example",
            "icon": "https://images.igdb.com/igdb/image/upload/t_thumb/co587b.jpg",
            "description": "Deep Learning Bird RPG",
            "year": 0,
            "sourceId": "IGDB",
            "sourceName": "IGDB",
            "fuzzy": 1
        },
        {
            "id": "31640",
            "name": "Glory by Example",
            "icon": "",
            "description": "A story driven, visual novel inspired, narrative experience chronicling the mysteries of an artificial island city and the tragedy of its few remaining survivors following the downfall of mankind by a world-wide virus outbreak and subsequent global flood. *Based on the released novel!",
            "year": 2016,
            "sourceId": "IGDB",
            "sourceName": "IGDB",
            "fuzzy": 1
        },
        {
            "id": "289018",
            "name": "Example Block Game",
            "icon": "https://images.igdb.com/igdb/image/upload/t_thumb/co7u03.jpg",
            "description": "Example Block Game is an open source implementation of basic block stacking in Lua/LÃ–VE. Featuring its own standardized kick table, the game has over 7 modes in total to use as reference for implementing your own gamemodes in its extensible engine.\n\nIn most modes, gameplay continues until you top out. High scores are saved per mode and can be viewed at any time from the main menu.",
            "year": 2022,
            "sourceId": "IGDB",
            "sourceName": "IGDB",
            "fuzzy": 1
        }
    ]
    ```

  </Col>
</Row>

---

## Import game {{ tag: 'POST', label: '/api/v1/admin/import/game', apilevel: "system", acl: "import:game:new" }}

<Row>
  <Col>

    This endpoint searches all metadata providers for a query.


    ### Request parameters

    <Properties>
      <Property name="library" type="string">
        The ID of the library you're importing from. Fetched from `library.id` on the GET endpoint.
      </Property>
      <Property name="path" type="string">
        Path of the game you're importing. Fetched from the `game` on the GET endpoint.
      </Property>
      <Property name="metadata" type="object">
        Optional, metadata to import from. It requires three fields if set:
        ```json
        {
            "id": "game ID",
            "sourceId": "source ID",
            "name": "Name of game"
        }
        ```

        All these properties are returned from the search endpoint. While you can guess these values, as they are generally the internal IDs of the respective platforms, they *are* internal values and are not recommended to be guessed.

        For example, if you had the game already from IGDB, you may be able to use:
        ```json
        {
            "id": "<IGDB ID>",
            "sourceId": "IGDB",
            "name": "<Name of game on IGDB>"
        }
        ```

        Without searching for the game first. *This is officially not recommended, but we are unlikely to break this behaviour.*
      </Property>
    </Properties>


    ### Response
    For the response and how to use task IDs, see [Tasks](/web/tasks). You need the `import:game:read` ACL to connect.

  </Col>
  <Col sticky>

    <CodeGroup title="Request" tag="POST" label="/api/v1/admin/import/game">

    ```bash {{ title: 'cURL' }}
    curl -X POST http://localhost:3000/api/v1/admin/import/game \
      -H "Authorization: Bearer {token}" \
      -H "Content-Type: application/json" \
      -d "{ ... }"

    ```

    ```js
    const response = await fetch("http://localhost:3000/api/v1/admin/import", {
        headers: {
            Authorization: "Bearer {token}"
        },
        method: "POST",
        body: {
            library: "8dc4b769-090f-4aec-b73a-d8fafc84f418",
            path: "SuperTuxKart",
            metadata: {
                id: "289018",
                sourceId: "IGDB",
                name: "Example Block Game"
            }
        }
    });

    const { taskId } = await response.json();

    ```

    </CodeGroup>

    ```json {{ title: 'Response' }}
    {
        "taskId": "..."
    }
    ```

  </Col>
</Row>

---

## Versions

Versions, in Drop, require a lot of metadata to be imported correctly, due to the various configurations that Drop supports. For that reason, the import endpoint is split into multiple by purpose.

---

## Fetch unimported versions {{ tag: 'GET', label: '/api/v1/admin/import/version', apilevel: "system", acl: "import:version:read" }}

<Row>
  <Col>

    This endpoint fetches all unimported versions on the instance.

    ### Query parameters

    <Properties>
      <Property name="id" type="string">
        The game ID to fetch the unimported versions from.
      </Property>
    </Properties>

  </Col>
  <Col sticky>

    <CodeGroup title="Request" tag="GET" label="/api/v1/admin/import/version">

    ```bash {{ title: 'cURL' }}
    curl -G http://localhost:3000/api/v1/admin/import/version?id={game id} \
      -H "Authorization: Bearer {token}"
    ```

    ```js
    const response = await fetch("http://localhost:3000/api/v1/admin/import/version?id={game id}", {
        headers: {
            Authorization: "Bearer {token}"
        },
    });

    const versions = await response.json();

    ```

    </CodeGroup>

    ```json {{ title: 'Response' }}
    {
        "versionName",
        "version2Name",
        "thatOtherVersion"
    }
    ```

  </Col>
</Row>

---

## Fetch unimported version 'preload' (metadata) {{ tag: 'GET', label: '/api/v1/admin/import/version/preload', apilevel: "system", acl: "import:version:read" }}

<Row>
  <Col>

    This endpoint fetches helpful metadata for unimported versions, and takes guesses on the type of version it is.

    You could thereotically use this endpoint to auto-import versions, but Drop opts for a manual process.

    ### Query parameters

    <Properties>
      <Property name="id" type="string">
        The game ID of the unimported version.
      </Property>
      <Property name="version" type="string">
        The version name of the unimported version.
      </Property>
    </Properties>


    ### Response properties
    This endpoint returns a **sorted** list of launch/setup command guesses.
    <Properties>
      <Property name="filename" type="string">
        The relative filename of the executable (includes folders, like `SubDir/MyGame.exe`).
      </Property>
      <Property name="platform" type="string">
        The platform this guess is for. Currently either "Windows", "Linux", or "macOS"
      </Property>
      <Property name="match" type="number">
        How closely the name of the executable matches the name of the game. It's used to make educated guesses on which executable is the right one, as games usually name their executables the same as the game name.
      </Property>
    </Properties>

  </Col>
  <Col sticky>

    <CodeGroup title="Request" tag="GET" label="/api/v1/admin/import/version/preload">

    ```bash {{ title: 'cURL' }}
    curl -G http://localhost:3000/api/v1/admin/import/version/preload?id={game id}&version={version name} \
      -H "Authorization: Bearer {token}"
    ```

    ```js
    const response = await fetch("http://localhost:3000/api/v1/admin/import/version/preload?id={game id}&version={version name}", {
        headers: {
            Authorization: "Bearer {token}"
        },
    });

    const versions = await response.json();

    ```

    </CodeGroup>

    ```json {{ title: 'Response' }}
    [
        {
            "filename": "run.sh",
            "platform": "Linux",
            "match": 0.332
        },
        {
            "filename": "MyGame",
            "platform": "Windows",
            "match": 0.1
        }
    ]
    ```

  </Col>
</Row>

---

## Portable, import version {{ tag: 'POST', label: '/api/v1/admin/import/version', apilevel: "system", acl: "import:version:new" }}

<Row>
  <Col>

    This way of using this endpoint is to import the game as a **portable** executable, meaning that there are separate launch commands, and an optional setup command.

    ### Request parameters

    <Properties>
      <Property name="id" type="string">
        The game ID of the unimported version.
      </Property>
      <Property name="version" type="string">
        The version name of the unimported version.
      </Property>
      <Property name="platform" type="string">
        The platform this version is for. Must be, currently, either "Windows", "Linux", or "macOS". You can mess up the capitalisation.
      </Property>
      <Property name="delta" type="boolean">
        Whether or not this version is a 'delta' version. Read more about delta versions on the main docs: [Version deltas & ordering](https://docs.droposs.org/docs/library#version-deltas--ordering)
      </Property>
      <Property name="onlySetup" type="boolean">
        Set as `false` for this example.
      </Property>
      <Property name="launch" type="string">
        The command to launch the game.
      </Property>
      <Property name="launchArgs" type="string">
        Additional arguments to pass to the game.
      </Property>
      <Property name="setup" type="string">
        Optional, a command to set up the game. If it returns successfully, the game is considered successfully installed, and clients will allow the user to run the `launch` command.
      </Property>
      <Property name="setupArgs" type="string">
        Optional, additional arguments to pass to the setup executable.
      </Property>
      <Property name="umuId" type="string">
        Optional, override the UMU ID for this game. Read more on the [UMU database](https://github.com/Open-Wine-Components/umu-database).
      </Property>
    </Properties>

    ### Response
    For the response and how to use task IDs, see [Tasks](/web/tasks). You need the `import:version:read` ACL to connect.

  </Col>
  <Col sticky>

    <CodeGroup title="Request" tag="GET" label="/api/v1/admin/import/version">

    ```bash {{ title: 'cURL' }}
    curl -X POST http://localhost:3000/api/v1/admin/import/version \
      -H "Authorization: Bearer {token}" \
      -H "Content-Type: application/json" \
      -d "{ ... }"

    ```

    ```js
    const response = await fetch("http://localhost:3000/api/v1/admin/import/version", {
        headers: {
            Authorization: "Bearer {token}"
        },
        method: "POST",
        body: {
            id: "...",
            version: "myVersion",
            platform: "Linux",

            delta: false,
            onlySetup: false, // Required for this example
            launch: "run.sh",

            // ... rest of the fields are optional
        }
    });

    const { taskId } = await response.json();

    ```

    </CodeGroup>

    ```json {{ title: 'Response' }}
    {
        "taskId": "..."
    }
    ```

  </Col>
</Row>

---

## Setup-only, import version {{ tag: 'POST', label: '/api/v1/admin/import/version', apilevel: "system", acl: "import:version:new" }}

<Row>
  <Col>

    This way of using this endpoint is to import the game as a **setup-only** executable, meaning that Drop just executes an installer **and that's it**. This is how many repacked and GOG games come, but it is recommended you install/unpack them first and then add them as portable games.

    ### Request parameters

    <Properties>
      <Property name="id" type="string">
        The game ID of the unimported version.
      </Property>
      <Property name="version" type="string">
        The version name of the unimported version.
      </Property>
      <Property name="platform" type="string">
        The platform this version is for. Must be, currently, either "Windows", "Linux", or "macOS". You can mess up the capitalisation.
      </Property>
      <Property name="delta" type="boolean">
        Whether or not this version is a 'delta' version. Read more about delta versions on the main docs: [Version deltas & ordering](https://docs.droposs.org/docs/library#version-deltas--ordering)
      </Property>
      <Property name="onlySetup" type="boolean">
        Set as `true` for this example.
      </Property>
      <Property name="launch" type="string">
        Not required for this example.
      </Property>
      <Property name="launchArgs" type="string">
        Not required for this example.
      </Property>
      <Property name="setup" type="string">
        A command to set up the game. Users will be able to run it multiple times, the installer should repair the installation.
      </Property>
      <Property name="setupArgs" type="string">
        Optional, additional arguments to pass to the setup executable.
      </Property>
      <Property name="umuId" type="string">
        Optional, override the UMU ID for this game. Read more on the [UMU database](https://github.com/Open-Wine-Components/umu-database).
      </Property>
    </Properties>

    ### Response
    For the response and how to use task IDs, see [Tasks](/web/tasks). You need the `import:version:read` ACL to connect.

  </Col>
  <Col sticky>

    <CodeGroup title="Request" tag="GET" label="/api/v1/admin/import/version">

    ```bash {{ title: 'cURL' }}
    curl -X POST http://localhost:3000/api/v1/admin/import/version \
      -H "Authorization: Bearer {token}" \
      -H "Content-Type: application/json" \
      -d "{ ... }"

    ```

    ```js
    const response = await fetch("http://localhost:3000/api/v1/admin/import/version", {
        headers: {
            Authorization: "Bearer {token}"
        },
        method: "POST",
        body: {
            id: "...",
            version: "myVersion",
            platform: "Linux",

            delta: false,
            onlySetup: true, // Required for this example
            setup: "setup.sh",
            setupArgs: "--gui"

            // ... rest of the fields are optional
        }
    });

    const { taskId } = await response.json();

    ```

    </CodeGroup>

    ```json {{ title: 'Response' }}
    {
        "taskId": "..."
    }
    ```

  </Col>
</Row>
